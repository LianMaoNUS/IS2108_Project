{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - AuroraMart Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'admin_panel/css/table_view.css' %}">
{% endblock %}

{% block content %}
<p class="modal-show" style="display: none;"> {{show_modal}}</p>
<p class="type-show" style="display: none;"> {{type}}</p>
<div class="action-bar">
    <div class="action-left">
        <form method="get" class="search-form" onsubmit="return false;">
            <input type="hidden" name="type" value="{{ type }}">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input id="searchInput" type="text" name="search" placeholder="Search by {{ search_field_label }}..." value="{{ search_query }}">
            </div>
        </form>
    </div>

    <div class="action-right">
        <a href="?type={{ type }}&export=csv" class="btn btn-secondary" id="exportCsvBtn" style="display:none;">
            <i class="fas fa-download"></i> Export CSV
        </a>
        {% if user_role == 'EDITOR' %}
        <button type="button" class="btn btn-danger btn-sm" id="deleteSelectedBtn" style="display:none;" onclick="deleteSelected()">
            <i class="fas fa-trash"></i> Delete Selected
        </button>
        <button type="button" class="btn btn-primary" onclick="addRecord()">
            <i class="fas fa-plus"></i> Add New
        </button>
        {% endif %}
    </div>
</div>


<!-- Table Controls -->
<div class="table-controls">
    <div class="control-left">
        <label>Show 
            <select onchange="updateRows(this.value)">
                <option value="10" {% if rows == '10' %}selected{% endif %}>10</option>
                <option value="25" {% if rows == '25' %}selected{% endif %}>25</option>
                <option value="50" {% if rows == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if rows == '100' %}selected{% endif %}>100</option>
            </select>
            entries
        </label>
    </div>

    <div class="control-right">
        <label>Sort by
            <select id="sortBySelect" onchange="updateSort(this.value)">
                {% for field in fields %}
                <option value="{{ field }}" {% if sort_by == field %}selected{% endif %}>{{ field|title }}</option>
                {% endfor %}
            </select>
        </label>
    </div>
</div>

<div class="table-wrapper">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    {% if user_role == 'EDITOR' %}
                    <th class="checkbox-col">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    </th>
                    {% endif %}
                    {% for field in fields %}
                    <th>
                        {{ field|title }}
                    </th>
                    {% endfor %}
                    {% if user_role == 'EDITOR' %}
                    <th class="actions-col">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in table_rows %}
                <tr>
                    {% if user_role == 'EDITOR' %}
                    <td class="checkbox-col">
                        <input type="checkbox" class="row-checkbox" value="{{ row.0 }}">
                    </td>
                    {% endif %}
                    {% for cell in row %}
                    <td>{{ cell }}</td>
                    {% endfor %}
                    {% if user_role == 'EDITOR' %}
                    <td class="actions-col">
                        <button type="button" class="btn-icon btn-edit" onclick="editRecord('{{ row.0 }}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn-icon btn-delete" onclick="deleteRecord('{{ row.0 }}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ fields|length|add:2 }}" class="text-center">No records found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<div class="pagination-wrapper">
    <div class="pagination-info">
        Showing page {{ current_page }} of {{ total_pages }} ({{ page_obj.paginator.count }} total entries)
    </div>

    <div class="pagination">
        {% if current_page > 1 %}
        <a href="?type={{ type }}&page=1&rows={{ rows }}{% if search_query %}&search={{ search_query }}{% endif %}&sort_by={{ sort_by }}" class="page-link">
            <i class="fas fa-angle-double-left"></i> First
        </a>
        {% endif %}

        {% if has_previous %}
        <a href="?type={{ type }}&page={{ previous_page }}&rows={{ rows }}{% if search_query %}&search={{ search_query }}{% endif %}&sort_by={{ sort_by }}" class="page-link">
            <i class="fas fa-chevron-left"></i> Previous
        </a>
        {% endif %}

        <span class="page-numbers">
            {% for num in paginator.page_range %}
                {% if num == current_page %}
                    <span class="page-link active">{{ num }}</span>
                {% elif num > current_page|add:'-3' and num < current_page|add:'3' %}
                    <a href="?type={{ type }}&page={{ num }}&rows={{ rows }}{% if search_query %}&search={{ search_query }}{% endif %}&sort_by={{ sort_by }}" class="page-link">{{ num }}</a>
                {% endif %}
            {% endfor %}
        </span>

        {% if has_next %}
        <a href="?type={{ type }}&page={{ next_page }}&rows={{ rows }}{% if search_query %}&search={{ search_query }}{% endif %}&sort_by={{ sort_by }}" class="page-link">
            Next <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}

        {% if current_page < total_pages %}
        <a href="?type={{ type }}&page={{ total_pages }}&rows={{ rows }}{% if search_query %}&search={{ search_query }}{% endif %}&sort_by={{ sort_by }}" class="page-link">
            Last <i class="fas fa-angle-double-right"></i>
        </a>
        {% endif %}
    </div>
</div>

<!-- Form Modal -->
{% if user_role == 'EDITOR' %}
<div id="formModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            {% if admin_details %}
            <h3>Edit Admin Details</h3>
            {% else %}
            <h3>{% if action == 'Update' %}Edit{% else %}Add New{% endif %} {{ page_title|slice:":-1" }}</h3>
            {% endif %}
            <button type="button" class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            {% if form %}
                <form method="post" id="modalForm" class="admin-form">
                    {% csrf_token %}
                    <div class="form-grid">
                        {% for field in form %}
                        <div class="form-field">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <div class="field-errors">
                                    {% for error in field.errors %}
                                        <span class="error-text">{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="no-form-message">
                    <p>Form not available.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'admin_panel/script/table_view.js' %}"></script>
{% endblock %}
